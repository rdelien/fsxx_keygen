#include <stdint.h>
#include <stdlib.h>


/******************************************************************************/
/*** Macros                                                                 ***/
/******************************************************************************/
#define ARRAY_SIZE(arr)         (sizeof(arr) / sizeof((arr)[0]))


/******************************************************************************/
/*** Types                                                                  ***/
/******************************************************************************/
enum mode_t {
	ENCRYPT,
	DECRYPT
};


/******************************************************************************/
/*** Global data                                                            ***/
/******************************************************************************/
/* Decryption permutation table */
static const uint8_t  decrypt_table[] = {
	0x09, 0x0A, 0x04, 0x1F, 0x1D, 0x15, 0x06, 0x17, 0x1E, 0x1B, 0x1C, 0x0E, 0x10, 0x02, 0x07, 0x0D,
	0x03, 0x05, 0x16, 0x08, 0x0C, 0x19, 0x18, 0x00, 0x1A, 0x01, 0x14, 0x0B, 0x12, 0x13, 0x11, 0x0F,
	0x1F, 0x0C, 0x1B, 0x11, 0x0D, 0x09, 0x0A, 0x15, 0x08, 0x04, 0x07, 0x1A, 0x17, 0x06, 0x01, 0x13,
	0x03, 0x0B, 0x0E, 0x05, 0x0F, 0x00, 0x16, 0x19, 0x12, 0x14, 0x1C, 0x02, 0x10, 0x1D, 0x1E, 0x18,
	0x0E, 0x02, 0x0D, 0x06, 0x1C, 0x12, 0x18, 0x0B, 0x0F, 0x1A, 0x16, 0x04, 0x1E, 0x05, 0x00, 0x1D,
	0x03, 0x13, 0x11, 0x01, 0x08, 0x07, 0x0C, 0x1F, 0x10, 0x17, 0x19, 0x15, 0x14, 0x1B, 0x09, 0x0A,
	0x0D, 0x0F, 0x1E, 0x19, 0x0E, 0x10, 0x0B, 0x13, 0x02, 0x14, 0x17, 0x01, 0x12, 0x05, 0x00, 0x09,
	0x03, 0x11, 0x0A, 0x06, 0x08, 0x15, 0x1C, 0x16, 0x1B, 0x1F, 0x1A, 0x18, 0x1D, 0x0C, 0x04, 0x07,
	0x10, 0x19, 0x08, 0x02, 0x05, 0x11, 0x16, 0x06, 0x07, 0x03, 0x0D, 0x14, 0x1C, 0x12, 0x1A, 0x18,
	0x1E, 0x13, 0x1F, 0x1D, 0x0A, 0x01, 0x0E, 0x00, 0x0C, 0x09, 0x15, 0x1B, 0x17, 0x0B, 0x0F, 0x04,
	0x18, 0x1C, 0x13, 0x09, 0x0F, 0x01, 0x05, 0x11, 0x00, 0x03, 0x17, 0x1A, 0x06, 0x1D, 0x10, 0x1F,
	0x0D, 0x12, 0x02, 0x16, 0x19, 0x0C, 0x08, 0x04, 0x0B, 0x15, 0x0A, 0x07, 0x1E, 0x1B, 0x14, 0x0E,
	0x10, 0x0A, 0x09, 0x04, 0x14, 0x08, 0x1F, 0x00, 0x1D, 0x05, 0x1B, 0x02, 0x0B, 0x12, 0x15, 0x03,
	0x0E, 0x13, 0x19, 0x16, 0x1E, 0x11, 0x0C, 0x17, 0x0D, 0x0F, 0x1A, 0x01, 0x1C, 0x07, 0x06, 0x18,
	0x05, 0x14, 0x1B, 0x0E, 0x06, 0x03, 0x07, 0x0A, 0x04, 0x11, 0x00, 0x01, 0x1F, 0x09, 0x18, 0x16,
	0x1A, 0x15, 0x0F, 0x1D, 0x08, 0x17, 0x02, 0x0D, 0x12, 0x10, 0x1C, 0x1E, 0x0B, 0x0C, 0x13, 0x19,
	0x06, 0x1E, 0x17, 0x07, 0x0A, 0x0E, 0x1D, 0x08, 0x0B, 0x14, 0x12, 0x01, 0x15, 0x0C, 0x09, 0x1F,
	0x19, 0x00, 0x0D, 0x16, 0x02, 0x04, 0x13, 0x0F, 0x18, 0x1B, 0x1C, 0x11, 0x1A, 0x05, 0x10, 0x03,
	0x16, 0x1B, 0x1F, 0x10, 0x12, 0x1A, 0x07, 0x0E, 0x0C, 0x02, 0x08, 0x1C, 0x13, 0x14, 0x05, 0x17,
	0x19, 0x03, 0x1D, 0x1E, 0x15, 0x0D, 0x0B, 0x01, 0x00, 0x06, 0x18, 0x0A, 0x0F, 0x11, 0x04, 0x09,
	0x0F, 0x17, 0x07, 0x1B, 0x18, 0x05, 0x1D, 0x0C, 0x1E, 0x08, 0x19, 0x0A, 0x11, 0x00, 0x1C, 0x0E,
	0x02, 0x13, 0x16, 0x1F, 0x1A, 0x04, 0x0D, 0x06, 0x15, 0x12, 0x01, 0x10, 0x14, 0x03, 0x09, 0x0B,
	0x08, 0x0A, 0x05, 0x1F, 0x1C, 0x09, 0x15, 0x19, 0x1E, 0x03, 0x13, 0x1A, 0x04, 0x14, 0x17, 0x01,
	0x16, 0x06, 0x00, 0x0C, 0x10, 0x0D, 0x02, 0x0E, 0x1D, 0x07, 0x0F, 0x0B, 0x11, 0x18, 0x1B, 0x12,
	0x17, 0x0A, 0x0B, 0x1C, 0x1B, 0x00, 0x19, 0x0E, 0x03, 0x11, 0x18, 0x0C, 0x07, 0x02, 0x05, 0x04,
	0x1A, 0x01, 0x15, 0x12, 0x10, 0x08, 0x16, 0x06, 0x1E, 0x1F, 0x0D, 0x14, 0x1D, 0x09, 0x0F, 0x13,
	0x0A, 0x15, 0x1F, 0x1B, 0x06, 0x07, 0x13, 0x1D, 0x02, 0x0D, 0x17, 0x1C, 0x12, 0x00, 0x1E, 0x16,
	0x1A, 0x01, 0x05, 0x0C, 0x09, 0x03, 0x08, 0x10, 0x19, 0x0F, 0x11, 0x18, 0x0E, 0x0B, 0x04, 0x14,
	0x05, 0x12, 0x0E, 0x03, 0x01, 0x02, 0x0B, 0x18, 0x17, 0x0A, 0x15, 0x13, 0x0D, 0x16, 0x1D, 0x07,
	0x14, 0x1C, 0x1A, 0x10, 0x00, 0x0C, 0x06, 0x1B, 0x11, 0x0F, 0x04, 0x1E, 0x08, 0x1F, 0x19, 0x09,
	0x1E, 0x1C, 0x05, 0x0E, 0x14, 0x18, 0x06, 0x15, 0x0D, 0x13, 0x0C, 0x10, 0x08, 0x1F, 0x19, 0x12,
	0x04, 0x0B, 0x1D, 0x16, 0x03, 0x07, 0x00, 0x1A, 0x09, 0x1B, 0x11, 0x02, 0x0A, 0x0F, 0x01, 0x17
};

/* Encryption permutation table */
static const uint8_t  encrypt_table[] = {
	0x17, 0x19, 0x0D, 0x10, 0x02, 0x11, 0x06, 0x0E, 0x13, 0x00, 0x01, 0x1B, 0x14, 0x0F, 0x0B, 0x1F,
	0x0C, 0x1E, 0x1C, 0x1D, 0x1A, 0x05, 0x12, 0x07, 0x16, 0x15, 0x18, 0x09, 0x0A, 0x04, 0x08, 0x03,
	0x15, 0x0E, 0x1B, 0x10, 0x09, 0x13, 0x0D, 0x0A, 0x08, 0x05, 0x06, 0x11, 0x01, 0x04, 0x12, 0x14,
	0x1C, 0x03, 0x18, 0x0F, 0x19, 0x07, 0x16, 0x0C, 0x1F, 0x17, 0x0B, 0x02, 0x1A, 0x1D, 0x1E, 0x00,
	0x0E, 0x13, 0x01, 0x10, 0x0B, 0x0D, 0x03, 0x15, 0x14, 0x1E, 0x1F, 0x07, 0x16, 0x02, 0x00, 0x08,
	0x18, 0x12, 0x05, 0x11, 0x1C, 0x1B, 0x0A, 0x19, 0x06, 0x1A, 0x09, 0x1D, 0x04, 0x0F, 0x0C, 0x17,
	0x0E, 0x0B, 0x08, 0x10, 0x1E, 0x0D, 0x13, 0x1F, 0x14, 0x0F, 0x12, 0x06, 0x1D, 0x00, 0x04, 0x01,
	0x05, 0x11, 0x0C, 0x07, 0x09, 0x15, 0x17, 0x0A, 0x1B, 0x03, 0x1A, 0x18, 0x16, 0x1C, 0x02, 0x19,
	0x17, 0x15, 0x03, 0x09, 0x1F, 0x04, 0x07, 0x08, 0x02, 0x19, 0x14, 0x1D, 0x18, 0x0A, 0x16, 0x1E,
	0x00, 0x05, 0x0D, 0x11, 0x0B, 0x1A, 0x06, 0x1C, 0x0F, 0x01, 0x0E, 0x1B, 0x0C, 0x13, 0x10, 0x12,
	0x08, 0x05, 0x12, 0x09, 0x17, 0x06, 0x0C, 0x1B, 0x16, 0x03, 0x1A, 0x18, 0x15, 0x10, 0x1F, 0x04,
	0x0E, 0x07, 0x11, 0x02, 0x1E, 0x19, 0x13, 0x0A, 0x00, 0x14, 0x0B, 0x1D, 0x01, 0x0D, 0x1C, 0x0F,
	0x07, 0x1B, 0x0B, 0x0F, 0x03, 0x09, 0x1E, 0x1D, 0x05, 0x02, 0x01, 0x0C, 0x16, 0x18, 0x10, 0x19,
	0x00, 0x15, 0x0D, 0x11, 0x04, 0x0E, 0x13, 0x17, 0x1F, 0x12, 0x1A, 0x0A, 0x1C, 0x08, 0x14, 0x06,
	0x0A, 0x0B, 0x16, 0x05, 0x08, 0x00, 0x04, 0x06, 0x14, 0x0D, 0x07, 0x1C, 0x1D, 0x17, 0x03, 0x12,
	0x19, 0x09, 0x18, 0x1E, 0x01, 0x11, 0x0F, 0x15, 0x0E, 0x1F, 0x10, 0x02, 0x1A, 0x13, 0x1B, 0x0C,
	0x11, 0x0B, 0x14, 0x1F, 0x15, 0x1D, 0x00, 0x03, 0x07, 0x0E, 0x04, 0x08, 0x0D, 0x12, 0x05, 0x17,
	0x1E, 0x1B, 0x0A, 0x16, 0x09, 0x0C, 0x13, 0x02, 0x18, 0x10, 0x1C, 0x19, 0x1A, 0x06, 0x01, 0x0F,
	0x18, 0x17, 0x09, 0x11, 0x1E, 0x0E, 0x19, 0x06, 0x0A, 0x1F, 0x1B, 0x16, 0x08, 0x15, 0x07, 0x1C,
	0x03, 0x1D, 0x04, 0x0C, 0x0D, 0x14, 0x00, 0x0F, 0x1A, 0x10, 0x05, 0x01, 0x0B, 0x12, 0x13, 0x02,
	0x0D, 0x1A, 0x10, 0x1D, 0x15, 0x05, 0x17, 0x02, 0x09, 0x1E, 0x0B, 0x1F, 0x07, 0x16, 0x0F, 0x00,
	0x1B, 0x0C, 0x19, 0x11, 0x1C, 0x18, 0x12, 0x01, 0x04, 0x0A, 0x14, 0x03, 0x0E, 0x06, 0x08, 0x13,
	0x12, 0x0F, 0x16, 0x09, 0x0C, 0x02, 0x11, 0x19, 0x00, 0x05, 0x01, 0x1B, 0x13, 0x15, 0x17, 0x1A,
	0x14, 0x1C, 0x1F, 0x0A, 0x0D, 0x06, 0x10, 0x0E, 0x1D, 0x07, 0x0B, 0x1E, 0x04, 0x18, 0x08, 0x03,
	0x05, 0x11, 0x0D, 0x08, 0x0F, 0x0E, 0x17, 0x0C, 0x15, 0x1D, 0x01, 0x02, 0x0B, 0x1A, 0x07, 0x1E,
	0x14, 0x09, 0x13, 0x1F, 0x1B, 0x12, 0x16, 0x00, 0x0A, 0x06, 0x10, 0x04, 0x03, 0x1C, 0x18, 0x19,
	0x0D, 0x11, 0x08, 0x15, 0x1E, 0x12, 0x04, 0x05, 0x16, 0x14, 0x00, 0x1D, 0x13, 0x09, 0x1C, 0x19,
	0x17, 0x1A, 0x0C, 0x06, 0x1F, 0x01, 0x0F, 0x0A, 0x1B, 0x18, 0x10, 0x03, 0x0B, 0x07, 0x0E, 0x02,
	0x14, 0x04, 0x05, 0x03, 0x1A, 0x00, 0x16, 0x0F, 0x1C, 0x1F, 0x09, 0x06, 0x15, 0x0C, 0x02, 0x19,
	0x13, 0x18, 0x01, 0x0B, 0x10, 0x0A, 0x0D, 0x08, 0x07, 0x1E, 0x12, 0x17, 0x11, 0x0E, 0x1B, 0x1D,
	0x16, 0x1E, 0x1B, 0x14, 0x10, 0x02, 0x06, 0x15, 0x0C, 0x18, 0x1C, 0x11, 0x0A, 0x08, 0x03, 0x1D,
	0x0B, 0x1A, 0x0F, 0x09, 0x04, 0x07, 0x13, 0x1F, 0x05, 0x0E, 0x17, 0x19, 0x01, 0x12, 0x00, 0x0D
} ;

/* Seed offset table */
static const uint32_t  offset_table[] = {
	0x07D00D940, 0x08488D256, 0x11FBDB21, 0x08838C862,
	0x0CF78A3D3, 0x07CBCB35C, 0x5F7C7140, 0x0CCBD55D8,
	0x01115AE60, 0x0E940852B, 0x651F66D0, 0x0BF9CF792,
	0x0DEFCD8D5, 0x0082D0E96, 0x0CD7B345, 0x0A64FD784
};

/* Seeds, as extracted from API.DLL. The number of seeds also defines the maximum number of options */
const uint32_t  seeds[] = {
	0x069AF1C1, 0x0632E6E4, 0x2AAC5519, 0x081B95E1,
	0x2E03E151, 0x19EF1119, 0x310EE121, 0x1756CE90,
	0x1919A691, 0x03DAD7E4, 0x2196F099, 0x3DD9B339,
	0x0E395E40, 0x195B9344, 0x2C7CE440, 0x08B0D139,
	0x13DE9644, 0x0CFD9839, 0x1AF16EA9, 0x11E04FA4,
	0x0BF1BE90, 0x03685351, 0x1A368DB9, 0x3A8A28B9,
	0x03BA3B10, 0x0AF61A31, 0x053D6400, 0x0D659100,
	0x3F26B9A4, 0x2626FF90, 0x1E0D3564, 0x26E9C161,
	0x2EFDA244, 0x16BF9900, 0x0EAFB3A1, 0x36C143D9,
	0x0F64FEB1, 0x1CC87A91, 0x3C3E8900, 0x3936AC24,
	0x2C810F89, 0x2C2CFE40, 0x08BA6899, 0x20230E90,
	0x157EA044, 0x39D8CC61, 0x19C84B04, 0x13B57040,
	0x30D449C4, 0x20418E41, 0x005200A4, 0x9047208D,
	0x317C62F8, 0xCF099E12, 0x95C32B85, 0x7AD8F5B1,
	0x59ACB359, 0xE55DCABA, 0xD2A5A54A, 0xBF217E42,
	0x2C925924, 0xDBE3B7C6, 0xB5E36BC6, 0x837706ED,
	0x4DD29BA4, 0x03D607AC, 0x17662ECC, 0x5D4CBA99,
	0x25B64B6C, 0x2A7854F0, 0xFD0FFA1E, 0x7218E431,
	0x1E7C3CF8, 0x01320264, 0x02480490, 0x60BCC179,
	0x881B1035, 0x92392471, 0x9A0D3419, 0x9B6F36DD,
	0x2A8E551C, 0xA9BD5379, 0x7366E6CD, 0x5A24B449,
	0x0E9A1D34, 0x9B913721, 0xC887910E, 0xCD779AEE,
	0x85170A2D, 0x4D4C9A98, 0xE03FC07E, 0xBA07740E,
	0xF4B5E96A, 0xECFBD9F6, 0x8A131425, 0x247048E0,
	0x764AEC95, 0x3C3E787C, 0xDCBBB976, 0x35A86B50,
	0xC7978F2E, 0xD7F9AFF2, 0xFF2DFE5A, 0xFFEBFFD6,
	0x9C8B3915, 0x6476C8ED, 0x4426884C, 0x4C1A9834,
	0xD713AE26, 0x06140C28, 0x6038C071, 0x17B62F6C,
	0xAD5D5ABA, 0x0E641CC8, 0x02400480, 0xEB35D66A,
	0x46A08D40, 0x45DC8BB8, 0x96812D01, 0xB0F161E2,
	0xD66DACDA, 0xB9FB73F6, 0x7C24F849, 0x34926924,
	0xBE657CCA, 0x77ECEFD9, 0x753CEA79, 0xF2FBE5F6,
	0xBE937D26, 0x1BB83770, 0x995B32B5, 0x629EC53D,
	0xBC297852, 0x9BE537C9, 0x92892511, 0x5C80B901,
	0x26CC4D98, 0x39A07340, 0x6CD6D9AD, 0xCD899B12,
	0x846108C1, 0xFD6FFADE, 0xC06580CA, 0x5876B0ED,
	0x2B425684, 0xA8455089, 0x7DECFBD9, 0x10442088,
	0xB3236646, 0x813B0275, 0x25C24B84, 0xF317E62E,
	0x243E487C, 0xE7B5CF6A, 0xB16162C2, 0x4D949B28,
	0x6D32DA65, 0x12042408, 0xF773EEE6, 0xAEE55DCA,
	0x273A4E74, 0xE093C126, 0xD259A4B2, 0x95012A01,
	0x30FC61F8, 0x2D8A5B14, 0xD133A266, 0x79AAF355,
	0x27D24FA4, 0x81010201, 0xBB6576CA, 0x67D4CFA9,
	0x47928F24, 0x91992331, 0xAEA75D4E, 0xC17F82FE,
	0xB8CF719E, 0x79ACF359, 0x1F7E3EFC, 0x5E28BC51,
	0xD5ADAB5A, 0x08FC11F8, 0x845B08B5, 0xA9B95371,
	0x6D1CDA39, 0x1ACC3598, 0xF307E60E, 0xEBDFD7BE,
	0x8CAF195D, 0x5892B125, 0x78C2F185, 0x5FFEBFFD,
	0xD8D3B1A6, 0x511EA23C, 0x74C2E985, 0x459A8B34,
	0xFBA3F746, 0x4C3C9878, 0xBD3B7A76, 0x91392271
};

const unsigned int  nr_of_seeds = ARRAY_SIZE(seeds);


/******************************************************************************/
/*** Static functions                                                       ***/
/******************************************************************************/
static uint32_t cipher(uint32_t nibble, uint32_t value, enum mode_t mode)
{
	unsigned char  bit;
	uint32_t       cph = 0;

	for (bit = 0; bit < 32; bit++)
		if (value & (1 << bit))
			cph |= 1 << ((mode == ENCRYPT) ? encrypt_table[(nibble << 5) + bit] :
			                                 decrypt_table[(nibble << 5) + bit]);

	return cph;
}


/*****************************************************************************/
/*** Functions                                                             ***/
/*****************************************************************************/
uint32_t fsxx_decrypt(const char *keyascii, uint32_t serialnr)
{
	unsigned int  nibble;
	uint32_t      shift = serialnr;
	uint32_t      key   = strtoul(keyascii, NULL, 10);

	/* Interate through all nibbles */
	for (nibble = 0; nibble < 8; nibble++) {
		key = cipher(shift & 0x0f, key - offset_table[shift & 0x0f], DECRYPT);
		shift >>= 4;
	}

	return key;
}


uint32_t fsxx_encrypt(uint32_t seed, uint32_t serialnr)
{
	unsigned int  nibble;
	uint32_t      shift;

	/* Interate through all nibbles */
	for (nibble = 0; nibble < 8; nibble++) {
		shift = serialnr >> (4 * (7 - nibble));
		seed  = cipher(shift & 0x0f, seed, ENCRYPT) + offset_table[shift & 0x0f];
	}

	return seed;
}
